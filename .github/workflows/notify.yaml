name: Notify Discord on pageupdate

on:
  push:  # √† chaque push

jobs:
  notify:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Send Discord message if commit contains "pageupdate"
        run: |
          echo "üì¶ SHA actuel : ${{ github.sha }}"
          echo "üì¶ SHA pr√©c√©dent : ${{ github.event.before }}"
          
          commit_message=$(git log -1 --pretty=%B)
          echo "üí¨ Message du commit : $commit_message"

          if echo "$commit_message" | grep -qi "pageupdate"; then
            echo "‚úÖ Mot-cl√© 'pageupdate' d√©tect√©."

            # Lister les fichiers .html modifi√©s entre les deux commits
            modified_files=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }} | grep '\.html' || true)
            echo "üìù Fichiers HTML modifi√©s : $modified_files"

            if [ -z "$modified_files" ]; then
              echo "‚ùå Aucun fichier .html modifi√©. Fin du job."
              exit 0
            fi

            for file in $modified_files; do
              page_url="https://terraminewiki.github.io/$file"
              content="TerraMineWiki Update !\n$commit_message\n$page_url"
              echo "üì§ Envoi vers Discord ‚ûú $page_url"

              curl -H "Content-Type: application/json" \
                   -X POST \
                   -d "{\"content\": \"$content\"}" \
                   "$DISCORD_WEBHOOK"
            done
          else
            echo "‚ùå Mot-cl√© 'pageupdate' non d√©tect√©. Aucune action."
          fi
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
          else
            echo "Aucun mot-cl√© 'pageupdate' d√©tect√© dans le commit. Aucun message envoy√©."
          fi
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
